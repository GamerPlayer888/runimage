name: ‚öôÔ∏è Continuous bootstrap üì¶

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" #At 00:00 UTC on Sunday every Week

jobs:
  bootstrap_and_release:
    name: runimage-bootstrap
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: main
          filter: "blob:none"

      - name: Install deps
        run: |
          sudo sh -c 'apt update && apt install qemu-user-static zsync -y'
          sudo tee /proc/sys/kernel/apparmor_restrict_unprivileged_userns <<<0
          docker pull tonistiigi/binfmt:latest
          docker run --privileged --rm tonistiigi/binfmt --uninstall qemu-*
          docker run --privileged --rm tonistiigi/binfmt --install all

      - name: Bootstrap RunImage
        run: |
            set -x ; set -e
            mkdir -p release && cd release||exit 1

            # x86_64
            PACKAGES="
              # audio
            	alsa-lib lib32-alsa-lib alsa-plugins lib32-alsa-plugins libpulse
            	lib32-libpulse alsa-tools alsa-utils pipewire lib32-pipewire pipewire-pulse pipewire-jack lib32-pipewire-jack
            	# core
            	xorg-xwayland qt6-wayland wayland lib32-wayland qt5-wayland xorg-server-xephyr gamescope
            	# video
            	vulkan-icd-loader lib32-vulkan-icd-loader
            	vulkan-tools mesa lib32-mesa vulkan-intel lib32-vulkan-intel
            	vulkan-mesa-layers lib32-vulkan-mesa-layers libva-intel-driver lib32-libva-intel-driver
            	intel-media-driver mesa-utils vulkan-tools libva-utils lib32-mesa-utils
            	# wine
            	wine-staging winetricks-git wine-nine wineasio
            	freetype2 lib32-freetype2 libxft lib32-libxft
            	flex lib32-flex fluidsynth lib32-fluidsynth
            	libxrandr lib32-libxrandr xorg-xrandr libldap lib32-libldap
            	libxcomposite lib32-libxcomposite
            	libxi lib32-libxi libxinerama lib32-libxinerama libxss lib32-libxss
            	libxslt lib32-libxslt openal lib32-openal
            	krb5 lib32-krb5 alsa-plugins
            	alsa-lib lib32-alsa-lib gnutls lib32-gnutls
            	giflib lib32-giflib gst-libav gst-plugin-pipewire gst-plugins-ugly
            	gst-plugins-bad gst-plugins-bad-libs
            	gst-plugins-base-libs lib32-gst-plugins-base-libs gst-plugins-base lib32-gst-plugins-base
            	gst-plugins-good lib32-gst-plugins-good gstreamer lib32-gstreamer
            	libpng lib32-libpng v4l-utils lib32-v4l-utils
            	libgpg-error lib32-libgpg-error libjpeg-turbo lib32-libjpeg-turbo
            	libgcrypt lib32-libgcrypt ncurses lib32-ncurses ocl-icd lib32-ocl-icd
            	libxcrypt-compat lib32-libxcrypt-compat libva lib32-libva sqlite lib32-sqlite
            	gtk3 lib32-gtk3 vulkan-icd-loader lib32-vulkan-icd-loader
            	sdl2-compat lib32-sdl2-compat vkd3d lib32-vkd3d libgphoto2
            	libnm lib32-libnm
            	cabextract wget gamemode lib32-gamemode mangohud protonplus
            	# gaming
            	lutris python-protobuf steam steamtinkerlaunch
            	prismlauncher obs-studio umu-launcher
            	dolphin-emu
            	# extra
            	ttf-dejavu ttf-liberation 
            	adobe-source-han-serif-cn-fonts adobe-source-han-serif-jp-fonts adobe-source-han-serif-kr-fonts 
            	adobe-source-han-serif-otc-fonts adobe-source-han-serif-tw-fonts 
            	mpv blender tesseract tesseract-data-eng kdenlive
            	rtorrent imv tmux leptonica zxing-cpp nautilus fish firefox passff-host pass-otp
            	yt-dlp minizip jre17-openjdk gnome-themes-extra ffmpegthumbnailer file-roller
            	gnome-network-displays obsidian scrcpy
            "
            ../main/rim-bootstrap $PACKAGES
            zsyncmake runimage-x86_64

            rm -f runimage

            echo "\
            -----------------------------------------------------------------------------------------------------------------------------
            * [runimage-x86_64](https://github.com/VHSgunzo/runimage/releases/download/continuous/runimage-x86_64) | [pkg_list-x86_64.txt](https://github.com/VHSgunzo/runimage/releases/download/continuous/pkg_list-x86_64.txt)
            -----------------------------------------------------------------------------------------------------------------------------
            * [runimage-aarch64](https://github.com/VHSgunzo/runimage/releases/download/continuous/runimage-aarch64) | [pkg_list-aarch64.txt](https://github.com/VHSgunzo/runimage/releases/download/continuous/pkg_list-aarch64.txt)
            -----------------------------------------------------------------------------------------------------------------------------
            " > ../RELEASE_NOTE.md

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "continuous"
          prerelease: false
          draft: false
          body_path: "RELEASE_NOTE.md"
          files: release/*
